<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Таро — выбор 3 карт</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root { --gap: 12px; --dur: .8s; --ratio: 1.6667; --cardW: 116px; }
  html,body{margin:0;height:100%;background:#0d1014;color:#fff;font-family:system-ui,Segoe UI,Roboto,Arial;}
  .wrap{max-width:920px;margin:0 auto;padding:14px 14px 40px;display:flex;flex-direction:column;gap:14px;}
  .rows{display:flex;flex-direction:column;gap:14px;align-items:center}
  .row{display:flex;gap:var(--gap);justify-content:center;align-items:center;width:100%}
  .card{position:relative;perspective:900px;width:var(--cardW);height:calc(var(--cardW)*var(--ratio));cursor:pointer;flex:0 0 auto}
  .card .card-inner{position:absolute; inset:0; overflow:visible; transform-style:preserve-3d; transition: transform var(--dur) ease, box-shadow .35s ease; box-shadow:0 6px 22px rgba(0,0,0,.45); transform: rotateY(180deg);}
  .card.selected .card-inner{transform: rotateY(0deg); box-shadow:0 0 22px rgba(230,200,145,.55),0 10px 22px rgba(0,0,0,.55);}
  .card.locked{pointer-events:none}
  .side{ position:absolute; inset:0; backface-visibility:hidden; transform-style:preserve-3d; display:flex; align-items:center; justify-content:center; }
  .side img{ width:100%; height:100%; object-fit:contain; display:block; }
  .side.face{ transform: rotateY(0deg) translateZ(0.1px); }
  .side.back{ transform: rotateY(180deg) translateZ(0.1px); }
  .fade-out{opacity:0;transition:opacity .3s ease}
  .floating{ position:fixed !important; z-index:40; margin:0 !important; transition: transform 1.5s ease-in-out !important; will-change:transform,left,top; transform-origin: top left; }
  .banner{position:fixed;left:50%;top:10px;transform:translateX(-50%);background:#b91c1c;color:#fff;padding:8px 12px;border-radius:10px;font-size:13px;display:none}
  .banner.show{display:block}
</style>
</head>
<body>
<div class="wrap">
  <div class="rows">
    <div class="row top" id="rowTop"></div>
    <div class="row bottom" id="rowBottom"></div>
  </div>
</div>
<div id="warn" class="banner">Откройте эту страницу из бота по кнопке — иначе данные не отправятся.</div>

<script>
(function(){
  const tg = (window.Telegram && Telegram.WebApp) ? Telegram.WebApp : null;
  if (tg){ try{ tg.ready(); tg.expand(); tg.setHeaderColor("secondary_bg_color"); }catch(e){} }
  else { document.getElementById('warn').classList.add('show'); }

  const V = 'v21'; // кеш-бастер
  const z2 = n => String(n).padStart(2,'0');
  const faceUrl = id => `faces/${z2(id)}.png?${V}`;
  const backUrl = `faces/back.png?${V}`;

  // Имена карт (0..77) — чтобы сформировать CSV на стороне клиента (на бота прилетят и ids, и names)
  const MAJORS = ["Шут","Маг","Верховная Жрица","Императрица","Император","Иерофант","Влюблённые","Колесница","Сила","Отшельник","Колесо Фортуны","Справедливость","Повешенный","Смерть","Умеренность","Дьявол","Башня","Звезда","Луна","Солнце","Суд","Мир"];
  const RANKS = ["Туз","Двойка","Тройка","Четвёрка","Пятёрка","Шестёрка","Семёрка","Восьмёрка","Девятка","Десятка","Паж","Рыцарь","Королева","Король"];
  const SUITS_ORDER = ["Жезлов","Кубков","Мечей","Пентаклей"];
  const MINORS = SUITS_ORDER.flatMap(suit => RANKS.map(r => `${r} ${suit}`));
  const CARD_NAMES = [...MAJORS, ...MINORS];
  const nameById = (id) => CARD_NAMES[id] ?? `Карта ${id}`;

  const rowTop = document.getElementById('rowTop');
  const rowBottom = document.getElementById('rowBottom');

  const ALL = Array.from({length:78}, (_,i)=>i);
  shuffle(ALL);
  const seed = ALL.slice(0,7);
  const topIds = seed.slice(0,3);
  const bottomIds = seed.slice(3,7);
  let selected = [];

  // MainButton (родной от Telegram)
  if (tg){
    tg.MainButton.setText("Продолжить");
    tg.MainButton.hide();
    tg.onEvent("mainButtonClicked", onDone);
  }

  preload([backUrl, ...seed.map(faceUrl)]).then(build);

  function onDone(){
    if (selected.length !== 3) return;
    const names = selected.map(id => nameById(id));
    const payload = { type:"three_cards", cards:selected, names:names.join(", ") };
    try{
      tg.MainButton.showProgress(true);
      tg.sendData(JSON.stringify(payload));
      setTimeout(()=>{ try{ tg.close(); }catch(e){} }, 120);
    }catch(e){
      // если по какой-то причине не внутри Telegram
      alert("Откройте страницу из бота по кнопке.\n\n" + JSON.stringify(payload));
    }
  }

  function build(){
    setCardW();
    topIds.forEach(id => rowTop.appendChild(makeCard(id)));
    bottomIds.forEach(id => rowBottom.appendChild(makeCard(id)));
    window.addEventListener('resize', setCardW, {passive:true});
    window.addEventListener('orientationchange', ()=>setTimeout(setCardW, 100));
  }

  function setCardW(){
    const vw = Math.min(window.innerWidth, document.documentElement.clientWidth);
    const vh = Math.min(window.innerHeight, document.documentElement.clientHeight);
    const sidePad = 28;
    const gaps = 3 * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--gap')) || 36;
    const maxByWidth = Math.floor((vw - sidePad - gaps) / 4);
    const headerH = 24, bottomPad = 60, rows = 2;
    const maxByHeight = Math.floor((vh - headerH - bottomPad - gaps) / (rows * 1.6667));
    const cardW = Math.max(80, Math.min(150, maxByWidth, maxByHeight));
    document.documentElement.style.setProperty('--cardW', cardW + 'px');
  }

  function makeCard(id){
    const card = document.createElement('div');
    card.className = 'card'; card.dataset.id = String(id);
    const inner = document.createElement('div'); inner.className = 'card-inner';

    const back = document.createElement('div'); back.className = 'side back';
    const backImg = document.createElement('img'); backImg.src = backUrl; backImg.alt = 'back'; back.appendChild(backImg);

    const face = document.createElement('div'); face.className = 'side face';
    const faceImg = document.createElement('img'); faceImg.src = faceUrl(id); faceImg.alt = `card-${z2(id)}`; face.appendChild(faceImg);

    inner.append(back, face); card.appendChild(inner);
    card.addEventListener('click', () => onPick(card, id));
    return card;
  }

  function onPick(card, id){
    if (selected.length >= 3) return;
    if (card.classList.contains('locked')) return;
    card.classList.add('selected','locked');
    selected.push(id);

    if (selected.length === 3){
      const inner = card.querySelector('.card-inner');
      const onEnd = (e) => {
        if (e.propertyName !== 'transform') return;
        inner.removeEventListener('transitionend', onEnd);
        moveToCenter();
      };
      inner.addEventListener('transitionend', onEnd);
    }
  }

  function moveToCenter(){
    document.querySelectorAll('.card').forEach(el => {
      const id = Number(el.dataset.id);
      if (!selected.includes(id)){
        el.classList.add('fade-out');
        el.style.pointerEvents = 'none';
      }
    });

    const chosen = selected.map(id => document.querySelector(`.card[data-id="${id}"]`));
    const rects = chosen.map(el => el.getBoundingClientRect());

    const gap = 16;
    const vw = Math.min(window.innerWidth, document.documentElement.clientWidth);
    const vh = Math.min(window.innerHeight, document.documentElement.clientHeight);

    const firstRect = rects[0];
    const targetW = Math.round(Math.min(150, Math.max(110, firstRect.width + 8)));
    const targetH = Math.round(targetW * 1.6667);
    const totalW  = targetW*3 + gap*2;
    const startX  = Math.round((vw - totalW)/2);
    const y       = Math.round((vh - targetH)/2);

    chosen.forEach((el, i) => {
      const r = rects[i];
      const l = Math.round(r.left);
      const t = Math.round(r.top);
      const w = Math.round(r.width);
      const h = Math.round(r.height);

      el.style.width  = w + 'px';
      el.style.height = h + 'px';
      el.style.left   = l + 'px';
      el.style.top    = t + 'px';
      el.classList.add('floating');

      const tx = Math.round(startX + i*(targetW + gap));
      const ty = y;
      const dx = tx - l;
      const dy = ty - t;
      const sx = targetW / w;
      const sy = targetH / h;

      requestAnimationFrame(()=>{ requestAnimationFrame(()=>{
        el.style.transform = `translate3d(${dx}px, ${dy}px, 0) scale(${sx}, ${sy})`;
      });});
    });

    // показать MainButton
    if (tg){ tg.MainButton.show(); }
  }

  function preload(urls){
    return Promise.all(urls.map(u => new Promise(res => { const im=new Image(); im.onload=im.onerror=res; im.src=u; })));
  }
  function shuffle(a){ for (let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; }
})();
</script>
</body>
</html>
